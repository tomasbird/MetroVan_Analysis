---
title: "Breanna_Code"
author: "Tom Bird"
date: "29/09/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preamble

Here we are going to use a markdown document to communicate draft code and results, to try and setup a template for how we would report on these data to a client.

## Load packages

I try and load packages separately from data.

```{r load_packages}
library(dplyr)
library(lme4)
library(tidyverse)

```

## Loading data

In future, we should try and work from either a formatted database or a .csv extracted from that formatted database, and those data should have metadata etc etc. For now we go with what we have.

```{r load_data}
#read saved data
Metrics <- readRDS("Data/Metrics.rds")
```

## view raw data

Note that the raw data contain characters that will make things tricky later on. I would exclude parenth etc as general practice. Also names are quite long, making it difficult to include in the models. This is where having a data dicitonary is useful, as you can keep descriptions, formal names, plot names available for use in figures.

```{r view_raw_data}
head(Metrics)
```

```{r data_dictionary}
#Putting a data dictionary here in case it is useful
dict=data.frame(longName=names(Metrics), shortName=c("Station", "Abundance", "Richness", "Biomass", "Diversity", "Evenness", "SDI", "Ax_Staining", "Year", "Rep", "Distance", "Direction"))

#new data file with short names for playing
metrics <- Metrics %>%
  mutate(DiffuserDirection=ifelse(DiffuserDirection==1, "upstream", "downstream"))
names(metrics)=dict$shortName
```

## Checking distributional assumptions

Here we would put put some text describing the results, and setting up the next section, in case there were transformations we wanted to do.

```{r histograms with ggplot}
metrics %>% 
  select(!c('Distance')) %>%
  pivot_longer(!c( 'Rep', 'Station', 'Year', 'Direction'), names_to="Indicator", values_to="value") %>%
  ggplot(aes(x=value, fill=Direction)) +
    geom_histogram()+
    facet_wrap(~Indicator, scale="free_x")
    
```

```{r plot_histograms}

par(mfrow=c(2,4))

hist(Metrics$`Total Abundance (ind/0.1m²)`)

hist(Metrics$`Total Richness`)

hist(log(Metrics$`Total biomass (g/0.1m²)`))

hist(Metrics$`Simpson's Diversity (1-D)`)

hist(Metrics$`Simpson's Evenness (E)`)

hist(Metrics$`Swartz Dominance Index (SDI)`)

hist(Metrics$`Percentage of Axinopsida with low shell staining`)
```

##Explore Variables Here were are looking at what the variables are relative to our indicators, and whether we want to add variable transformations.

###Asses if trends are reasonably linear Here we should be plotting response variables against predictors.

### Distance

Definitely some trends with distance, but also definitely some non-linear things happening

```{r scatterplots in ggplot}
#Distance scatterplot

metrics %>% 
  #select(!c('Direction')) %>%
  pivot_longer(!c( 'Rep', 'Station', 'Year', 'Distance', 'Direction'), names_to="Indicator",  values_to="value") %>%
  ggplot(aes(x=Distance, y=value, fill=Direction)) +
    geom_point()+
    facet_wrap(~Indicator, scale="free_y")

```

### Direction

```{r Direction scatterplot}

metrics %>% 
  select(!c('Distance')) %>%
  pivot_longer(!c( 'Rep', 'Station', 'Year', 'Direction'), names_to="Indicator", values_to="value") %>%
  ggplot(aes(x=Direction, y=value)) +
    geom_boxplot()+
    facet_wrap(~Indicator, scale="free_y")

```

```{r plot_response_v_predictor}
# these are a good use of pipes, but don't give us an easy way to assess for linearity in the key variables. 
Metrics %>%

  select(DiffuserDistance, DiffuserDirection, `Total Abundance (ind/0.1m²)`) %>%

  plot()

Metrics %>%

  select(DiffuserDistance, DiffuserDirection, `Total Richness`) %>%

  plot()

Metrics %>%

  select(DiffuserDistance, DiffuserDirection, `Total biomass (g/0.1m²)`) %>%

  plot()

Metrics %>%

  select(DiffuserDistance, DiffuserDirection, `Simpson's Diversity (1-D)`) %>%

  plot()

Metrics %>%

  select(DiffuserDistance, DiffuserDirection, `Simpson's Evenness (E)`) %>%

  plot()

Metrics %>%

  select(DiffuserDistance, DiffuserDirection, `Swartz Dominance Index (SDI)`) %>%

  plot()

Metrics %>% 

  select(DiffuserDistance, DiffuserDirection, `Percentage of Axinopsida with low shell staining`) %>%

  plot()
```

## modeling section

```{r models}
# Example model
library(lme4)
trialmodel=glmer(`Total Abundance (ind/0.1m²)` ~ DiffuserDirection + DiffuserDistance + DiffuserDirection:DiffuserDistance + (1|Station), data = Metrics, family = poisson)

# no random effects
norfx=glm(`Total Abundance (ind/0.1m²)` ~ DiffuserDirection + DiffuserDistance + DiffuserDirection:DiffuserDistance,  data = Metrics, family = poisson)
```

Some text here
